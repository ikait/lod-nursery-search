<!doctype html>
<html lang="ja">
<meta charset="UTF-8">
<title>生活班LOD</title>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
<script type="text/javascript">

$(function () {
  $('#youchien').submit(function (e) {
    e.preventDefault();
    var self = this;

    var querytext = (function (){

      var requiredItems = [
        {name: 'name', prop: 'http://dbpedia.org/property/name'},
        {name: 'owner', prop: 'http://data.tom.sfc.keio.ac.jp/property/設置者名'},
        {name: 'zipcode', prop: 'http://dbpedia.org/property/zipcode'},
        {name: 'address', prop: 'http://dbpedia.org/property/address'},
        {name: 'long', prop: 'http://www.w3.org/2003/01/geo/wgs84_pos#long'},
        {name: 'lat', prop: 'http://www.w3.org/2003/01/geo/wgs84_pos#lat'},
        {name: 'phoneNumber', prop: 'http://dbpedia.org/property/phoneNumber'},
        {name: 'website', prop: 'http://dbpedia.org/property/website'},
      ];

      var optionalItems = [
        {name: 'azukari', prop: 'http://data.tom.sfc.keio.ac.jp/property/預かり保育'},
        {name: 'bus', prop: 'http://data.tom.sfc.keio.ac.jp/property/通園バス'},
        {name: 'kyushoku', prop: 'http://data.tom.sfc.keio.ac.jp/property/給食'},
        {name: 'capacity', prop: 'http://data.tom.sfc.keio.ac.jp/property/定員（合計）'},
        {name: 'capacity3', prop: 'http://data.tom.sfc.keio.ac.jp/property/定員（３歳）'},
        {name: 'capacity4', prop: 'http://data.tom.sfc.keio.ac.jp/property/定員（４歳）'},
        {name: 'capacity5', prop: 'http://data.tom.sfc.keio.ac.jp/property/定員（５歳）'},
        {name: 'time2', prop: 'http://data.tom.sfc.keio.ac.jp/property/保育時間帯（２歳）'},
        {name: 'time3', prop: 'http://data.tom.sfc.keio.ac.jp/property/保育時間帯（３歳）'},
        {name: 'time4', prop: 'http://data.tom.sfc.keio.ac.jp/property/保育時間帯（４歳）'},
        {name: 'time5', prop: 'http://data.tom.sfc.keio.ac.jp/property/保育時間帯（５歳）'},
        {name: 'time6', prop: 'http://data.tom.sfc.keio.ac.jp/property/保育時間帯（６歳）'}
      ];

      var querytext = [
        'SELECT *',
        ' { ',
        // 検索条件を決める
        (function () {
          var s = [];
          // 常にほしいもの
          requiredItems.forEach(function (item) {
            s.push('?s <' + item.prop + '> ?' + item.name + ' .');
          });
          // オプション
          optionalItems.forEach(function (item) {
            $('input:checked', self).each(function () {
              if (this.value == item.name) {
                s.push('?s <' + item.prop + '> ?' + item.name + ' .');
                s.push('filter(?' + item.name +  '="true")');
              }
            });
          });
          return s.join(' ');
        })(),
        '} limit 20'
      ].join('');

      return querytext;

    })();

    console.log(querytext);

    $.ajax({
      type: 'post',
      url: 'http://data.tom.sfc.keio.ac.jp/sparql',
      dataType: 'jsonp',
      data: {
        query: querytext
      },
      success: function(data) {
        renderResult(data);
      },
      error: function() {
        console.log('error');
      }
    });

    var renderResult = function (data) {
      $result = $("#result");
      $result.empty();

      $result.append(
        '<tr>' +
        '<th>' + '名前' + '</th>' +
        '<th>' + '設置者名' + '</th>' +
        '<th>' + '電話番号' + '</th>' +
        '<th>' + '緯度' + '</th>' +
        '<th>' + '経度' + '</th>' +
        '</tr>'
      );

      data.forEach(function (youchien) {
        $result.append(
          '<tr>' +
          '<td>' + youchien.name.value + '</td>' +
          '<td>' + youchien.owner.value + '</td>' +
          '<td>' + youchien.phoneNumber.value + '</td>' +
          '<td>' + youchien.lat.value + '</td>' +
          '<td>' + youchien.long.value + '</td>' +
          '</tr>'
        );

      });
    };

  });
});

</script>
<body>
<header id="header">

</header>
<section id="search">
  <form id="youchien" method="post" action="">
    <ul>
      <li>
        定員とか保育時間からも検索したい
      </li>
      <li>
        <label><input type="checkbox" name="condition" value="azukari" checked>預かり保育</label>
      </li>
      <li>
        <label><input type="checkbox" name="condition" value="bus" checked>通園バス</label>
      </li>
      <li>
        <label><input type="checkbox" name="condition" value="kyushoku" checked>給食</label>
      </li>
    </ul>
    <p>
      <input type="submit">
    </p>
  </form>
</section>
<section id="result">

</section>
</body>
</html>
